name: Branch Protection

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - main

jobs:
  check-direct-push:
    name: Check for Direct Push to Main
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check if push is from PR merge
        id: check-merge
        run: |
          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # Check if this is a merge commit from a PR
          # GitHub's merge commits typically contain "Merge pull request #" or are merge commits
          if git log -1 --merges | grep -q "commit"; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "This is a merge commit"
          elif echo "$COMMIT_MSG" | grep -q "Merge pull request #"; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "This is a PR merge"
          elif echo "$COMMIT_MSG" | grep -q "^chore(changelog): update for PR #"; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "This is a changelog update commit (allowed)"
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
            echo "This is a direct push"
          fi

      - name: Validate commit follows conventional commits
        if: steps.check-merge.outputs.is_merge == 'false'
        run: |
          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # Check if commit follows conventional commits format
          if echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"; then
            echo "✅ Commit follows conventional commits format"
            echo "Commit message: $COMMIT_MSG"
          else
            echo "❌ Direct push to main detected that does not follow conventional commits format!"
            echo "Commit message: $COMMIT_MSG"
            echo ""
            echo "Direct pushes to main are only allowed for:"
            echo "1. Merge commits from pull requests"
            echo "2. Automated changelog updates"
            echo "3. Commits that follow conventional commits format"
            echo ""
            echo "Please use pull requests for all changes."
            exit 1
          fi

      - name: Create issue for direct push violation
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commit = context.sha;
            const pusher = context.actor;
            const commitMsg = await github.rest.git.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });

            const body = `## ⚠️ Direct Push to Main Branch Detected

            **Pusher:** @${pusher}
            **Commit:** ${commit}
            **Message:** \`${commitMsg.data.message}\`

            Direct pushes to the \`main\` branch are not allowed except for:
            1. Merge commits from pull requests
            2. Automated changelog updates
            3. Emergency hotfixes that follow conventional commits format

            **Action Required:**
            - If this was unintentional, please revert this commit
            - For future changes, please create a pull request
            - Ensure all PR titles follow the [Conventional Commits](https://www.conventionalcommits.org/) specification

            **Conventional Commits Format:**
            \`\`\`
            <type>(<scope>): <subject>
            \`\`\`

            **Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert

            **Examples:**
            - \`feat(auth): add OAuth2 login support\`
            - \`fix(api): resolve race condition in user endpoint\`
            - \`docs(readme): update installation instructions\`

            This issue was automatically created by the branch protection workflow.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Direct push to main by @${pusher} - ${commit.substring(0, 7)}`,
              body: body,
              labels: ['branch-protection', 'needs-review']
            });
